# Integration with Malware Bazzar API
## Table of Contents
- [Introduction](#introduction)
- [Implementation](#implementation)
  - [Configuration](#configuration)
  - [Changing Permission](#changing-permission)
  - [Modifying ossec.conf file](#modifying-ossecconf-file)
  - [Creating Rules](#creating-rules)
- [Restart Wazuh Service](#restart-wazuh-service)
## Introduction
The Python script forwards the file hash to the MalwareBazaar API for verification. If the hash is identified in the MalwareBazaar database, it returns data.malwarebazaar.found=1; otherwise, it returns data.malwarebazaar.found=0. This functionality can be integrated with both syscheck (file integrity monitoring) and Sysmon Event ID 1 (process creation events).
## Implementation
### Configuration
Write the script on a file /var/ossec/integrations/custom-malwarebazzar.py
~~~
vim /var/ossec/integrations/custom-malwarebazzar.py
~~~

### Modifying Permission
Modify the permission of the file so that the script can be executed by the wazuh using the command
```
chmod 750 /var/ossec/integrations/custom-malwarebazzar.py
chown root:wazuh /var/ossec/integrations/custom-malwarebazzar.py
```
### Modifying Configuration file
Open the ossec.conf file and insert the integration block shown below to forward the hash to the MalwareBazaar API, using the rule ID specified in the configuration.
```
<integration>
  <name>custom-malwarebazzar</name>
  <hook_url>https://mb-api.abuse.ch/api/v1/ </hook_url>
  <api_key>API_KEY</api_key> <!-- YOUR MALWARE BAZZAR API-->
  <rule_id>RULE_ID</rule_id> <!-- RULE_ID -->
  <alert_format>json</alert_format>
</integration>
```
_The logs received will be in json format so we don't need to create a decoder for it_ <br />
_The rules are created based on the log fields fetched which is data.malwarebazaar.found_ <br />
Now Create the custom rules named malware.<br />
### Creating Rules
```
<group name="malware,">
  </rule>
    <rule id="100002" level="5">
    <decoded_as>json</decoded_as>
    <field name="integration">custom-malwarebazaar</field>
    <description>Checked for malware</description>
    <group>malware,</group>
  </rule>
  <rule id="100003" level="14">
    <if_sid>100002</if_sid>
    <field name="malwarebazaar.found">1</field>
    <description>Danger Malware</description>
    <group>malware,</group>
  </rule>
</group>
```
Save the configuration 

### Restart Wazuh Service
We can now restart the Wazuh service either from the dashboard or by using the command below.
```
systemctl restart wazuh-manager
```
